- name: Set up modules-load.d/k8s.conf
  ansible.builtin.shell: |
    cat <<EOF | sudo tee /etc/modules-load.d/k8s.conf
    overlay
    br_netfilter
    EOF
  with_items: "{{ master_ip_addresses }}"
  delegate_to: "{{ item }}"
  
- name: Load kernel modules
  ansible.builtin.shell: |
    sudo modprobe overlay && sudo modprobe br_netfilter
  with_items: "{{ master_ip_addresses }}"
  delegate_to: "{{ item }}"

- name: Configure sysctl.d/k8s.conf
  ansible.builtin.shell: |
    cat <<EOF | sudo tee /etc/sysctl.d/k8s.conf
    net.bridge.bridge-nf-call-iptables = 1
    net.bridge.bridge-nf-call-ip6tables = 1
    net.ipv4.ip_forward = 1
    EOF
  with_items: "{{ master_ip_addresses }}"
  delegate_to: "{{ item }}"

- name: Apply sysctl settings
  ansible.builtin.shell: sudo sysctl --system
  with_items: "{{ master_ip_addresses }}"
  delegate_to: "{{ item }}"